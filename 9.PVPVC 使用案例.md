[TOC]

# 使用案例

## NFS

NFS SERVER 创建

```shell
mkdir /data/volumes/v1
cat /etc/exports
/data/volumes/v1 192.168.1.0/24(rw,no_root_squash)

exportfs -arv
exporting 192.168.1.0/24:/data/volumes/v1

showmount -e
/data/volumes/v1 192.168.1.0/24

```

创建 pv, pv是属于集群资源，所以不能添加 namespace, 如果全部删除pv , kubectl delete pv --all

```shell
cat > pv-nfs.yaml <<EOF
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-001
  labels:
    name: pv-nfs-001
spec:
  storageClassName: nfs-slow
  accessModes: ["ReadWriteMany","ReadWriteOnce"]
  capacity:
    storage: 6Gi
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /data/volumes/v1
    server: 192.168.1.20
EOF

kubectl apply -f pv-nfs.yaml 
kubectl get pv
NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM     STORAGECLASS   REASON    AGE
pv-nfs-001   6Gi        RWO,RWX        Retain           Available                nfs-slow              3s

```

创建 pvc

```shell
cat > pvc-nfs.yaml <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mypvc
  namespace: default
spec:
  accessModes: 
    - ReadWriteMany  # 访问模式要和PV accessModes要子集
  volumeMode: Filesystem
  resources:
    requests:
      storage: 6Gi
  storageClassName: nfs-slow  # 这个名字和PV的storageClassName要一致
EOF
```

创建pod

```shell
apiVersion: v1
kind: Pod
metadata:
  name: pod-vol-pvc
  namespace: default
spec:
  containers:
  - name: myapp-nfs
    image: ikubernetes/myapp:v1
    imagePullPolicy: IfNotPresent
    ports:
    - name: http
      containerPort: 80
    - name: https
      containerPort: 443
    volumeMounts:
    - name: html
      mountPath: /usr/share/nginx/html/
  volumes:
  - name: html
    persistentVolumeClaim:
      claimName: mypvc
      readOnly: false

[root@docker-k8s-01 volume]# kubectl apply -f pvc-nfs.yaml 

[root@docker-k8s-01 volume]# kubectl get pv
NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM           STORAGECLASS   REASON    AGE
pv-nfs-001   2Gi        RWO,RWX        Retain           Available                                            38m
pv-nfs-002   5Gi        RWO            Retain           Available                                            38m
pv-nfs-003   20Gi       RWO,RWX        Retain           Available                                            38m
pv-nfs-004   10Gi       RWO,RWX        Retain           Bound       default/mypvc                            38m
pv-nfs-005   10Gi       RWO,RWX        Retain           Available                                            38m

[root@docker-k8s-01 volume]# kubectl get pvc
NAME      STATUS    VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE
mypvc     Bound     pv-nfs-004   10Gi       RWO,RWX                       47s

[root@docker-k8s-01 volume]# kubectl get pods
NAME          READY     STATUS    RESTARTS   AGE
pod-vol-pvc   1/1       Running   0          1m

```



















